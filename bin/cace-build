#!/usr/bin/env bash
set -euo pipefail

SCRIPT_NAME="$(basename "${BASH_SOURCE[0]}")"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

# Keep in sync with the local CACE checkout / release you’re targeting.
CACE_VERSION="2.5.0"
CACE_DIR="/home/tony/business/tools/cross-agent-compatibility-engine"

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

log_info() { echo -e "${BLUE}[info]${NC} $*"; }
log_success() { echo -e "${GREEN}[ok]${NC} $*"; }
log_warn() { echo -e "${YELLOW}[warn]${NC} $*"; }
log_error() { echo -e "${RED}[error]${NC} $*" >&2; }
log_section() { echo -e "\n${CYAN}═══ $* ═══${NC}\n"; }

usage() {
  cat <<USAGE
Usage: $SCRIPT_NAME [--skip-convert] [--skip-validation] [--dry-run]

Build committed \`outputs/\` for this repository using CACE.

This script is intended for maintainers (build-time generation), not end users.

Options:
  --skip-convert       Only (re)build outputs/claude from agents/claude-code
  --skip-validation    Skip CACE validation pass
  --dry-run            Print planned actions without changing files
USAGE
}

check_node_version() {
  if ! command -v node >/dev/null 2>&1; then
    log_error "Node.js is required (>= 18)."
    exit 1
  fi

  local major
  major="$(node --version 2>/dev/null | sed 's/^v//' | cut -d. -f1 || echo "")"
  if [[ -z "$major" || "$major" -lt 18 ]]; then
    log_error "Node.js >= 18 required. Found: $(node --version 2>/dev/null || echo 'unknown')"
    exit 1
  fi
}

run_cace() {
  if [[ -f "$CACE_DIR/dist/cli/index.js" ]]; then
    node "$CACE_DIR/dist/cli/index.js" "$@"
    return 0
  fi

  if command -v cace >/dev/null 2>&1; then
    cace "$@"
    return 0
  fi

  log_error "CACE not available. Expected local checkout at: $CACE_DIR"
  log_error "Or install globally: npm install -g cace-cli@$CACE_VERSION"
  exit 1
}

DRY_RUN=false
SKIP_CONVERT=false
SKIP_VALIDATION=false

while [[ $# -gt 0 ]]; do
  case "$1" in
    --dry-run) DRY_RUN=true; shift ;;
    --skip-convert) SKIP_CONVERT=true; shift ;;
    --skip-validation) SKIP_VALIDATION=true; shift ;;
    --help|-h) usage; exit 0 ;;
    *) log_warn "Unknown option: $1"; usage; exit 1 ;;
  esac
done

check_node_version

OUTPUTS_DIR="$REPO_ROOT/outputs"
CLAUDE_SRC="$REPO_ROOT/agents/claude-code"
CLAUDE_OUT="$OUTPUTS_DIR/claude/.claude"

ensure_dir() {
  local dir="$1"
  if [[ "$DRY_RUN" == "true" ]]; then
    log_info "[dry-run] mkdir -p \"$dir\""
  else
    mkdir -p "$dir"
  fi
}

copy_tree() {
  local src="$1"
  local dst="$2"

  if [[ ! -d "$src" ]]; then
    log_error "Missing directory: $src"
    exit 1
  fi

  ensure_dir "$dst"
  if [[ "$DRY_RUN" == "true" ]]; then
    log_info "[dry-run] cp -R \"$src\"/. \"$dst\"/"
  else
    cp -R "$src"/. "$dst"/
  fi
}

log_section "Building outputs/claude (canonical)"
if [[ "$DRY_RUN" == "true" ]]; then
  log_info "[dry-run] rm -rf \"$OUTPUTS_DIR\""
else
  rm -rf "$OUTPUTS_DIR"
fi
ensure_dir "$CLAUDE_OUT"

copy_tree "$CLAUDE_SRC/output-styles" "$CLAUDE_OUT/output-styles"
copy_tree "$CLAUDE_SRC/rules" "$CLAUDE_OUT/rules"
copy_tree "$CLAUDE_SRC/hooks" "$CLAUDE_OUT/hooks"
copy_tree "$CLAUDE_SRC/skills" "$CLAUDE_OUT/skills"
copy_tree "$CLAUDE_SRC/config" "$CLAUDE_OUT/config"

if [[ "$SKIP_CONVERT" != "true" ]]; then
  log_section "Generating outputs/* via CACE convert-dir"

  # We convert ONLY the canonical Claude skills directory (like agent-deep-toolkit),
  # then overlay repo-specific agent assets (rules/hooks/workflows/plugins) that
  # are not representable via skill conversion.
  #
  # Use dual-output for maximum parity where supported:
  # - Windsurf: workflows + skills
  # - Cursor: commands + skills
  local_skills_dir="$CLAUDE_OUT/skills"
  if [[ ! -d "$local_skills_dir" ]]; then
    log_error "Missing skills directory: $local_skills_dir"
    exit 1
  fi

  for agent in windsurf cursor opencode; do
    log_info "Converting skills to $agent..."

    # Pre-create expected dual-output structures (CACE will write into these).
    if [[ "$DRY_RUN" != "true" ]]; then
      if [[ "$agent" == "windsurf" ]]; then
        mkdir -p "$OUTPUTS_DIR/$agent/.windsurf/skills"
      elif [[ "$agent" == "cursor" ]]; then
        mkdir -p "$OUTPUTS_DIR/$agent/.cursor/skills" "$OUTPUTS_DIR/$agent/.cursor/commands"
      fi
    fi

    if [[ "$DRY_RUN" == "true" ]]; then
      log_info "[dry-run] cace convert-dir \"$local_skills_dir\" --to \"$agent\" --strategy dual-output --output \"$OUTPUTS_DIR/$agent\""
    else
      run_cace convert-dir "$local_skills_dir" --to "$agent" --strategy dual-output --output "$OUTPUTS_DIR/$agent"
    fi
  done

  log_section "Post-processing generated outputs"
  # CACE may embed local absolute paths in conversion metadata comments.
  # Strip those to keep outputs portable and OSS-friendly.
  if [[ "$DRY_RUN" == "true" ]]; then
    log_info "[dry-run] would strip '<!-- Original: ... -->' comments from generated files"
  else
    while IFS= read -r -d '' file; do
      tmp="$(mktemp)"
      awk '!/^<!-- Original: /{print}' "$file" > "$tmp"
      mv "$tmp" "$file"
    done < <(find "$OUTPUTS_DIR" -type f \( -name "*.md" -o -name "SKILL.md" \) -print0)
  fi
fi

log_section "Overlaying repo-specific agent assets"

# Windsurf: keep the curated rules/workflow/hooks that match the docs.
ensure_dir "$OUTPUTS_DIR/windsurf/.windsurf"
copy_tree "$REPO_ROOT/agents/windsurf/rules" "$OUTPUTS_DIR/windsurf/.windsurf/rules"
copy_tree "$REPO_ROOT/agents/windsurf/workflows" "$OUTPUTS_DIR/windsurf/.windsurf/workflows"
copy_tree "$REPO_ROOT/agents/windsurf/hooks" "$OUTPUTS_DIR/windsurf/.windsurf/hooks"

# Cursor: curated rule + enhanced-mode assets (hook template + manual context skill)
ensure_dir "$OUTPUTS_DIR/cursor/.cursor"
copy_tree "$REPO_ROOT/agents/cursor/rules" "$OUTPUTS_DIR/cursor/.cursor/rules"
copy_tree "$REPO_ROOT/agents/cursor/hooks" "$OUTPUTS_DIR/cursor/.cursor/hooks"
copy_tree "$REPO_ROOT/agents/cursor/skills" "$OUTPUTS_DIR/cursor/.cursor/skills"

# OpenCode: keep plugin + instructions
ensure_dir "$OUTPUTS_DIR/opencode/.opencode"
copy_tree "$REPO_ROOT/agents/opencode/plugins" "$OUTPUTS_DIR/opencode/.opencode/plugins"
copy_tree "$REPO_ROOT/agents/opencode/instructions" "$OUTPUTS_DIR/opencode/.opencode/instructions"
copy_tree "$REPO_ROOT/agents/opencode/skills" "$OUTPUTS_DIR/opencode/.opencode/skills"

if [[ "$SKIP_VALIDATION" != "true" ]]; then
  log_section "Validating outputs with CACE"
  if [[ "$DRY_RUN" == "true" ]]; then
    log_info "[dry-run] cace validate (selected core artifacts)"
  else
    # Claude
    run_cace validate "$OUTPUTS_DIR/claude/.claude/skills/analyze-boxes/SKILL.md" --from claude --type skill --strict
    run_cace validate "$OUTPUTS_DIR/claude/.claude/rules/response-boxes.md" --from claude --type rule --strict

    # Windsurf
    run_cace validate "$OUTPUTS_DIR/windsurf/.windsurf/workflows/response-boxes-start.md" --from windsurf --type workflow --strict
    run_cace validate "$OUTPUTS_DIR/windsurf/.windsurf/rules/response-boxes.md" --from windsurf --type rule --strict

    # Cursor
    run_cace validate "$OUTPUTS_DIR/cursor/.cursor/rules/response-boxes.mdc" --from cursor --type rule --strict
    run_cace validate "$OUTPUTS_DIR/cursor/.cursor/skills/response-boxes-context/SKILL.md" --from cursor --type skill --strict

    # OpenCode (validate the skill; plugin TS is out-of-scope for CACE)
    run_cace validate "$OUTPUTS_DIR/opencode/.opencode/skills/analyze-boxes/SKILL.md" --from opencode --type skill --strict
  fi
fi

log_section "Done"
log_success "Outputs written to: $OUTPUTS_DIR"
log_success "Next: commit outputs/ and bump release metadata"

